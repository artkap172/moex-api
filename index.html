<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOEX Live –ö–æ—Ç–∏—Ä–æ–≤–∫–∏</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .wrapper {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .status-bar {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            color: white;
            text-align: center;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
        }
        .status-bar.loading { background: rgba(255, 193, 7, 0.3); }
        .status-bar.success { background: rgba(76, 175, 80, 0.3); }
        .status-bar.error { background: rgba(244, 67, 54, 0.3); }
        table {
            width: 100%;
            background: white;
            border-collapse: collapse;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        tbody tr:hover {
            background: #f5f5f5;
        }
        tbody tr:last-child td {
            border-bottom: none;
        }
        .ticker { font-weight: bold; color: #667eea; }
        .price { font-size: 1.1em; font-weight: bold; }
        .price.up { color: #4CAF50; }
        .price.down { color: #f44336; }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error-msg {
            color: #f44336;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <div class="header">
            <h1>üìä MOEX Live</h1>
            <p>–ö–æ—Ç–∏—Ä–æ–≤–∫–∏ —Ñ—å—é—á–µ—Ä—Å–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</p>
        </div>

        <div class="status-bar loading" id="status">
            <span class="loading-spinner"></span> –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>

        <table id="data-table">
            <thead>
                <tr>
                    <th>–ö–æ–¥</th>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–¶–µ–Ω–∞</th>
                    <th>High</th>
                    <th>Low</th>
                    <th>–≠–∫—Å–ø–∏—Ä–∞—Ü–∏—è</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <tr><td colspan="6" style="text-align: center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        const BACKEND_URL = 'https://moex-api-5kg3.onrender.com/api/moex';
        const statusEl = document.getElementById('status');
        const tableBodyEl = document.getElementById('table-body');

        function updateStatus(text, type) {
            statusEl.textContent = text;
            statusEl.className = 'status-bar ' + type;
        }

        function renderTable(instruments) {
            const today = new Date();
            const active = instruments.filter(inst => {
                if (!inst.LASTTRADEDATE) return false;
                try {
                    const exp = new Date(inst.LASTTRADEDATE);
                    return exp >= today;
                } catch {
                    return false;
                }
            }).slice(0, 100); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 100

            if (active.length === 0) {
                tableBodyEl.innerHTML = '<tr><td colspan="6" style="text-align: center;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤</td></tr>';
                return;
            }

            tableBodyEl.innerHTML = active.map(inst => {
                const price = inst.PREVSETTLEPRICE || 0;
                const high = inst.HIGHLIMIT || '-';
                const low = inst.LOWLIMIT || '-';
                return `<tr>
                    <td class="ticker">${inst.SECID || '-'}</td>
                    <td>${inst.SECNAME || '-'}</td>
                    <td class="price">${price}</td>
                    <td>${high}</td>
                    <td>${low}</td>
                    <td>${inst.LASTTRADEDATE || '-'}</td>
                </tr>`;
            }).join('');

            updateStatus('‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date().toLocaleTimeString(), 'success');
        }

        function loadData() {
            updateStatus('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...', 'loading');

            fetch(BACKEND_URL, { method: 'GET' })
                .then(r => {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(data => {
                    if (!data.securities || !data.securities.data) throw new Error('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö');
                    const cols = data.securities.columns;
                    const rows = data.securities.data;
                    const instruments = rows.map(row => {
                        const obj = {};
                        cols.forEach((col, i) => obj[col] = row[i]);
                        return obj;
                    });
                    renderTable(instruments);
                })
                .catch(err => {
                    updateStatus('‚ùå –û—à–∏–±–∫–∞: ' + err.message, 'error');
                    console.error(err);
                });
        }

        loadData();
        setInterval(loadData, 30000);
    </script>
</body>
</html>
