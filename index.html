<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MOEX –§—å—é—á–µ—Ä—Å—ã</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f5f5f5; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { text-align: center; color: #333; }
    .status { text-align: center; padding: 10px; background: #e8f5e9; border-radius: 4px; margin: 20px 0; }
    table { width: 100%; background: white; border-collapse: collapse; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    th { background: #2196F3; color: white; padding: 12px; text-align: left; font-weight: bold; }
    td { padding: 10px 12px; border-bottom: 1px solid #ddd; }
    tr:hover { background: #f5f5f5; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìä MOEX –§—å—é—á–µ—Ä—Å—ã (Live)</h1>
    <div class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    <div id="main-table"></div>
  </div>

  <script>
    const BACKEND_URL = 'https://moex-api-5kg3.onrender.com/api/moex';

    function displayTable(instruments) {
      const today = new Date();
      const active = instruments.filter(inst => {
        if (!inst.LASTTRADEDATE) return false;
        try {
          const exp = new Date(inst.LASTTRADEDATE);
          return exp >= today;
        } catch {
          return false;
        }
      });

      let html = '<table><thead><tr>';
      html += '<th>–ö–æ–¥</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞</th><th>High</th><th>Low</th><th>–≠–∫—Å–ø–∏—Ä–∞—Ü–∏—è</th>';
      html += '</tr></thead><tbody>';

      for (const inst of active) {
        html += '<tr>';
        html += '<td>' + (inst.SECID || '-') + '</td>';
        html += '<td>' + (inst.SECNAME || '-') + '</td>';
        html += '<td>' + (inst.PREVSETTLEPRICE || '-') + '</td>';
        html += '<td>' + (inst.HIGHLIMIT || '-') + '</td>';
        html += '<td>' + (inst.LOWLIMIT || '-') + '</td>';
        html += '<td>' + (inst.LASTTRADEDATE || '-') + '</td>';
        html += '</tr>';
      }

      html += '</tbody></table>';
      document.getElementById('main-table').innerHTML = html;
      document.getElementById('status').innerHTML = '‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ: ' + new Date().toLocaleTimeString();
    }

    function loadData() {
      fetch(BACKEND_URL)
        .then(r => r.json())
        .then(data => {
          if (data.securities && data.securities.data && data.securities.columns) {
            const cols = data.securities.columns;
            const rows = data.securities.data;
            const instruments = rows.map(row => {
              const obj = {};
              cols.forEach((col, i) => obj[col] = row[i]);
              return obj;
            });
            displayTable(instruments);
          }
        })
        .catch(e => {
          document.getElementById('status').innerHTML = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
        });
    }

    loadData();
    setInterval(loadData, 30000);
  </script>
</body>
</html>
